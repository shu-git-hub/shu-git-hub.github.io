<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å˜èªå¸³ã‚¢ãƒ—ãƒªï¼ˆç”»åƒå¯¾å¿œç‰ˆï¼‰</title>
<style>
body { font-family:sans-serif; text-align:center; padding:30px; background:#f4f6f9; }
.card { background:white; padding:30px; border-radius:10px; max-width:600px; margin:auto; }
button { padding:10px 20px; margin:10px; border:none; cursor:pointer; }
.correct { background:#4CAF50; color:white; }
.incorrect { background:#f44336; color:white; }
.pass { background:#777; color:white; }
img { height:60px; vertical-align:middle; margin:0 5px; }
</style>
</head>
<body>

<h1>ğŸ“˜ å˜èªå¸³ã‚¢ãƒ—ãƒªï¼ˆç”»åƒå¯¾å¿œç‰ˆï¼‰</h1>

<div class="card">
  <h2 id="questionArea">å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“</h2>
  <div id="answerArea" style="margin:20px;font-weight:bold;"></div>

  <button onclick="showAnswer()">ç­”ãˆã‚’è¦‹ã‚‹</button>

  <div id="resultButtons" style="display:none;">
    <button class="correct" onclick="record('correct')">æ­£è§£</button>
    <button class="incorrect" onclick="record('incorrect')">ä¸æ­£è§£</button>
    <button class="pass" onclick="record('pass')">ãƒ‘ã‚¹</button>
  </div>

  <hr>
  <button onclick="loadJSON()">JSONèª­ã¿å–ã‚Š</button>
</div>

<br>
<button onclick="location.href='register.html'">å•é¡Œç™»éŒ²</button>
<button onclick="location.href='list.html'">å•é¡Œä¸€è¦§</button>

<script>
let words = JSON.parse(localStorage.getItem("words")) || [];
let imageMap = {};  // ID/åå‰ â†’ URL
let current = null;

/* ========================
   ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆé–¢æ•°
======================== */
async function generateHash(text) {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,"0")).join("");
}

/* ========================
   ç”»åƒJSONèª­ã¿è¾¼ã¿
======================== */
async function loadImages() {
  const resp = await fetch("images.json");
  const imgs = await resp.json();
  imgs.forEach(item => {
    imageMap[item.id] = item.url;
    imageMap[item.name] = item.url;
  });
}

/* ========================
   ãƒ†ã‚­ã‚¹ãƒˆå†…ID/åå‰ã‚’ç”»åƒã«ç½®æ›
======================== */
function renderTextWithImages(text) {
  return text.replace(/\b(\w+_\w+|u\d+|i\d+)\b/g, (match) => {
    if (imageMap[match]) return `<img src="${imageMap[match]}" alt="${match}">`;
    return match;
  });
}

/* ========================
   JSONå•é¡Œèª­ã¿è¾¼ã¿ï¼ˆé‡è¤‡å›é¿ï¼‰
======================== */
async function loadJSON() {
  try {
    await loadImages(); // ç”»åƒãƒãƒƒãƒ—å…ˆã«èª­ã¿è¾¼ã‚€
    const response = await fetch("questions.json");
    const jsonData = await response.json();

    let existing = JSON.parse(localStorage.getItem("words")) || [];
    const existingHashes = new Set(existing.map(item => item.hash));

    for (const item of jsonData) {
      const hash = await generateHash(item.question + "||" + item.answer);
      if (!existingHashes.has(hash)) {
        existing.push({ 
          id: Date.now() + Math.random(),
          question: item.question,
          answer: item.answer,
          correct: 0,
          incorrect: 0,
          pass: 0,
          hash
        });
        existingHashes.add(hash);
      }
    }

    localStorage.setItem("words", JSON.stringify(existing));
    words = existing;
    alert("JSONèª­ã¿è¾¼ã¿å®Œäº†ï¼ˆç”»åƒå¯¾å¿œï¼‰");
    loadRandom();
  } catch (err) {
    console.error(err);
    alert("JSONèª­ã¿è¾¼ã¿å¤±æ•—");
  }
}

/* ========================
   ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ
======================== */
function loadRandom() {
  if (words.length === 0) {
    document.getElementById("questionArea").textContent = "å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“";
    document.getElementById("answerArea").innerHTML = "";
    return;
  }
  current = words[Math.floor(Math.random() * words.length)];
  document.getElementById("questionArea").innerHTML = renderTextWithImages(current.question);
  document.getElementById("answerArea").innerHTML = "";
  document.getElementById("resultButtons").style.display = "none";
}

function showAnswer() {
  if (!current) return;
  document.getElementById("answerArea").innerHTML = renderTextWithImages(current.answer);
  document.getElementById("resultButtons").style.display = "block";
}

function record(type) {
  let data = JSON.parse(localStorage.getItem("words")) || [];
  const index = data.findIndex(item => item.hash === current.hash);
  if (index !== -1) data[index][type]++;
  localStorage.setItem("words", JSON.stringify(data));
  words = data;
  loadRandom();
}

/* ========================
   åˆæœŸè¡¨ç¤º
======================== */
loadRandom();
</script>
</body>
</html>
